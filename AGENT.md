AGENT.md　 — 労働環境ガバナンスチェックエージェント（詳細設計＋UIテキスト図）

**目的**：ユーザーがアップロードした複数画像＋説明テキストをもとに、日本の法令・規格・社内基準へ照合し、**温度0（必須/義務）と温度0.7（提案/ベストプラクティス）の二段階で根拠付き指摘を提示し、重要度順に整理したPDFレポート**を生成する。これにより、多様な業務現場に潜む法的リスク、労災リスク、第三者への危害リスクを監査時に網羅的に検出し、見落としを防止する仕組みを構築する。


この書類は全体の仕様書です、作業記録を同一のディレクトリにあるWORKLOG.mdに記載して、この書類は計画管理の進捗管理をおこないます、不明な部分や曖昧な部分は必ずユーザーへ質問すること。

**重要：AIへの指示はAGENT.mdかWORKLOG.mdに記載する。他のファイルを参照する場合は、どちらかのファイルにその旨を記載しておくこと。**

## **ファイル参照ガイド**

### 主要ファイル構成
- `app/main.py` - Streamlit UIとメインアプリケーション（エントリーポイント）
- `app/models.py` - PydanticモデルとOpenAI API呼び出し
- `app/assess.py` - 法的評価ロジックと分析
- `app/two_stage_analysis.py` - 二段階分析の実装
- `app/pdf.py` - PDF生成ユーティリティ
- `app/utils.py` - 画像I/O、ハッシュ、PIIぼかし、例外処理
- `app/rules.yml` - 法的ルールパック設定
- `app/tests.py` - テストケース
- `requirements.txt` - Python依存関係
- `README.md` - プロジェクト概要とセットアップ手順

### AIコーディング時の参照ルール
1. **コード変更時**: 変更対象ファイルの機能と役割を`AGENT.md`または`WORKLOG.md`に記載
2. **新機能追加時**: 実装方針と設計思想を`AGENT.md`に記載
3. **バグ修正時**: 問題の原因と解決方法を`WORKLOG.md`に記載
4. **設定変更時**: 変更理由と影響範囲を`AGENT.md`に記載




## **0. 仕様サマリ（MVP）**

* **モデル**：既定 = gpt-4.1-mini（プルダウンで gpt-4.1 へ切替可）
* **入出力**：画像（複数）＋ユーザー説明／不足Q\&A → JSON評価結果 → PDFレポート
* **UI**：Streamlit（絵文字は不使用、**線・円・ボックス**で視覚整理／**独自ファビコン**）
* **環境**：Python 3.11、仮想環境必須、OpenAI APIキーは環境変数から取得
* **観点**：日本の法令・規格に基づく包括的コンプライアンス分析（労働安全衛生法、建築基準法、食品衛生法、個人情報保護法、会社法、消防法等）
* **順序**：アップロード → 初期説明 → 不足質問(温度0) → 回答 → 義務判定(温度0) → 提案(温度0.7) → PDF

## **0.5 画面イメージ（テキスト図）**

初回に共有されたExcel風モックの流れを**Streamlit**で再現。絵文字は使わず、線・円・枠で構成。

┌─────────────────────────────────────────────────────────────┐  
│ 〔ヘッダー〕 労働環境ガバナンスチェック ──────────────────────────────│  
│  \[モデル] gpt-4.1-mini ▼   \[法令] 労安衛生法 □ 建築基準法 □ 食品衛生法 □ 個人情報保護法 □ 会社法 □ 消防法 □ │
│  \[規格] ISO9001 □ ISO14001 □ ISO45001 □ Pマーク □ JIS □ その他 □ │  
│  \[設定] max\_questions=5 | max\_suggestions=5 | max\_evidence=3 | タイムアウト=60s         │  
└─────────────────────────────────────────────────────────────┘

進捗ステッパー（線＋円）  
● アップロード ─── ○ 説明入力 ─── ○ 不足質問/回答 ─── ○ 評価（義務/提案） ─── ○ PDF

┌─────────────── 左カラム ───────────────┐  ┌─────────────── 右カラム ───────────────┐  
│ \[画像アップロード]                                         │  │ \[説明テキスト]                                           │  
│ ┌──────────────────────────────────────────┐ │  │  何の画像か？何をしているか？                             │  
│ │  ドラッグ\&ドロップ（複数可）。プレビューはサムネを格子表示。 │ │  例: 「電気工事の高所作業で分電盤交換」「保護具なしで作業」「PC画面が見える状態で離席」「素手で調理」                  │  
│ └──────────────────────────────────────────┘ │  │                                                          │  
│ \[オプション]  EXIF除去 □  PIIぼかし（顔/名札/車番） □             │  │ \[実行]  解析開始 ▶                                         │  
└───────────────────────────────────────────┘  └───────────────────────────────────────────┘

\[結果タブ]  
┌─────────────────────────────────────────────────────────────┐  
│  タブ: ① 義務(温度0) | ② 提案(温度0.7) | ③ 重要度ビュー | ④ Q\&Aログ | ⑤ PDF │  
├─────────────────────────────────────────────────────────────┤  
│ ① 義務(温度0)                                                                  │  
│  ┌───────────── 観点カード(太線) ─────────────┐  ┌───────────── 観点カード ─────────────┐ │  
│  │ \[労安/墜落] 判定: 不明  | risk\_score: 80                 │  │ \[食品/交差汚染] 判定: 不適合 | risk\_score: 70       │ │  
│  │ 観察根拠: ハーネス視認/接続点不明                          │  │ 観察根拠: 肉と野菜が同一台上、器具色分け不明             │ │  
│  │ 規格根拠: 安衛則○条△項（要点）                            │  │ 規格根拠: HACCP一般衛生管理（要点）                     │ │  
│  │ 追加質問: 高さ/親綱/足場種別                              │  │ 追加質問: 専用まな板/包丁/洗浄手順                      │ │  
│  └───────────────────────────────────────────────┘  └───────────────────────────────┘ │  
│  …（観点カードが横断的に並ぶ。重大は左）                                         │  
├─────────────────────────────────────────────────────────────┤  
│ ② 提案(温度0.7)                                                              │  
│  - ベストプラクティス提案（各観点 3〜5件、根拠メタ付）                          │  
├─────────────────────────────────────────────────────────────┤  
│ ③ 重要度ビュー（円＋棒によるヒート）                                          │  
│  ● 重大（赤枠）  ○ 中   ○ 軽微     ── 上から risk\_score 降順                   │  
├─────────────────────────────────────────────────────────────┤  
│ ④ Q\&Aログ                                                                    │  
│  - 自動生成質問（温度0） ↔ ユーザー回答の時系列                                   │  
├─────────────────────────────────────────────────────────────┤  
│ ⑤ PDF                                                                        │  
│  \[レポート生成] ▶   ファイル名: YYYYMMDD\_HHMM\_JST\_<推論タイトル>.pdf            │  
└─────────────────────────────────────────────────────────────┘

**ポイント**

* **義務**（温度0）と**提案**（温度0.7）を**タブと枠線**で明確に分離。
* **進捗ステッパー**は線＋円で現在工程を強調（色はコントラスト高め）。
* 重要度ビューは**risk\_score降順**のカード/バーで俯瞰表示。
* 絵文字は使わず、**線/円/太線ボックス**で情報の階層を表現。

## **1. 対象職場シーンと法令・規格対応**

### **1.1 多様な職場シーン対応**
- **建設・工事現場**: 高所作業、足場作業、重機操作、電気工事、配管工事
- **製造・工場**: 機械操作、組立作業、検査作業、化学物質取扱い、品質管理
- **ガスプラント・化学工場**: 危険物取扱い、圧力容器、配管設備、安全装置
- **システム開発・IT**: プログラミング、システム設計、データベース管理、セキュリティ
- **セールス・営業**: 顧客訪問、商談、契約締結、商品説明、アフターサービス
- **店舗・小売**: 商品陳列、接客、レジ作業、在庫管理、清掃・メンテナンス
- **調理・食品加工**: 食材調理、食品加工、衛生管理、温度管理、器具管理
- **トレーニング・教育**: 研修実施、講習会、実習指導、安全講習
- **運転・配送**: 車両運転、配送作業、荷物積載、ルート管理、安全運転
- **オフィス・事務**: デスクワーク、会議、書類管理、個人情報取扱い

### **1.2 法令・規格対応マトリックス**

| 職場シーン | 主要法令 | 関連規格 | 重点チェック項目 |
|------------|----------|----------|------------------|
| 建設・工事 | 労働安全衛生法、建築基準法 | ISO45001, JIS | 墜落防止、保護具、足場安全 |
| 製造・工場 | 労働安全衛生法、消防法 | ISO9001, ISO14001 | 機械安全、化学物質管理 |
| ガスプラント | 高圧ガス保安法、消防法 | ISO45001, JIS | 圧力管理、安全装置、緊急時対応 |
| IT・システム | 個人情報保護法、会社法 | Pマーク, ISO27001 | 情報セキュリティ、内部統制 |
| セールス・営業 | 景表法、独占禁止法 | ISO9001 | 適正表示、競争法遵守 |
| 店舗・小売 | 食品衛生法、消防法 | ISO9001, HACCP | 衛生管理、避難経路 |
| 調理・食品 | 食品衛生法、HACCP | ISO22000, HACCP | 交差汚染防止、温度管理 |
| トレーニング | 労働安全衛生法、教育基本法 | ISO9001 | 教育効果、安全指導 |
| 運転・配送 | 道路交通法、労働安全衛生法 | ISO45001 | 安全運転、労働時間管理 |
| オフィス・事務 | 個人情報保護法、会社法 | Pマーク, ISO27001 | 情報管理、内部統制 |

## **2. フェーズ分割（各フェーズ終わりに「動作テスト＋3視点チェック」を実施）**

### **フェーズ1：要件定義・アーキテクチャ**

#### **1.1 強化された2段階アプローチ**

**第1段階：画像認識とシーン分類（温度0.0）**
- 画像から職場シーンを特定（建設現場、工場、オフィス、店舗、調理場等）
- 作業内容の詳細分析（高所作業、機械操作、調理作業、PC作業等）
- 視覚的リスク要因の検出（保護具未着用、危険な配置、不適切な作業姿勢等）
- 法令・規格の適用可能性の判定

**第2段階：深層リスク分析とコンプライアンス評価（温度0.0/0.7）**
- 第1段階の結果を基に、該当する法令・規格を詳細分析
- 観察根拠と規格根拠の分離記述
- リスクスコア算出（severity × likelihood × 10）
- 改善提案の生成（ベストプラクティス）

#### **1.2 法令・規格ルールパック定義**
- **労働安全衛生法**: 墜落防止、保護具、機械安全、化学物質管理
- **建築基準法・電気事業法**: 建築基準、電気設備、ガス設備
- **食品衛生法・HACCP**: 衛生管理、交差汚染防止、温度管理
- **個人情報保護法・Pマーク**: 情報セキュリティ、個人情報管理
- **会社法**: 取締役責任、内部統制、コンプライアンス体制
- **消防法**: 消火器配置、避難経路、火災報知器
- **ISO規格**: ISO9001（品質）、ISO14001（環境）、ISO45001（安全）、ISO27001（情報セキュリティ）
- **JIS規格**: 日本工業規格に基づく技術基準

#### **1.3 階層化リスク検知システム**

**コアリスクパターン抽出アプローチ**
- **労災事故データベース**: 過去の重大事故・インシデントから抽出した必須チェックポイント
- **LLM知識補完**: コアパターンでカバーできない部分をLLMの知識で補完
- **漏れ防止メカニズム**: シーン別の必須チェック領域を定義し、漏れを自動検出

**段階的ルール適用**
1. **第1段階**: コアリスクパターンマッチング（確実性重視）
2. **第2段階**: LLMによる詳細分析（柔軟性重視）
3. **第3段階**: 漏れ防止チェック（網羅性確保）

**法令データベース最適化**
- **階層化**: 基本ルール（必須）→ 詳細ルール（オプション）→ 専門ルール（高度）
- **動的読み込み**: シーンに応じて必要なルールのみを読み込み
- **キャッシュ機能**: 頻繁に使用されるルールをメモリに保持

#### **1.4 データスキーマとPDF構成**
- **JSON出力**: シーン分類、リスク評価、法令根拠、改善提案
- **PDF構成**: 表紙、Top3リスク、画像サムネ、観点別分析、Q&Aログ、免責事項
- **画面フロー**: 上記テキスト図の配置を準拠
- **モデル選択UI**: gpt-4.1-mini/gpt-4.1と温度固定（0 / 0.7）
- 3視点チェック：LLM/UX/Python（簡潔に）

### **フェーズ2：入出力基盤（GUI・画像取込・セキュリティ）**

* Streamlit UI骨子（テキスト図準拠）、複数画像、説明入力、独自ファビコン
* 画像I/O（サムネ格子表示）、EXIF除去、PIIぼかし（顔/名札/車番）
* APIキーは環境変数 OPENAI\_API\_KEY から取得
* 3視点チェック：前処理プロンプト/視線誘導/安全なI/O

### **フェーズ3：不足情報質問（温度0）と対話フロー**

* 画像→シーン推定→**義務の穴**を質問化（max\_questions）。シーン推定結果（例：建設現場、厨房）に基づき、関連性の高いルールパックから優先的に質問を生成し、監査の網羅性を高める。
* 回答を中間JSONに反映、未解決は継続提示
* 3視点チェック：高リスク優先/1画面内完結/状態管理の明快さ

### **フェーズ4：義務判定（温度0）＋提案生成（温度0.7）**

* 義務：適合/不適合/不明＋観察根拠＋規格根拠（条項名＋要点）
* 提案：max\_suggestions で出力（根拠メタ付き）
* 重要度：severity×likelihood→risk\_score、降順整列
* 3視点チェック：温度分離/視覚分離/評価関数のテスト性

### **フェーズ5：PDF生成・エクスポート**

* ファイル名：YYYYMMDD\_HHMM\_JST\_<推論タイトル>.pdf

  * **<推論タイトル>の生成**：最もrisk\_scoreが高い指摘事項の要約（例：高所作業でのハーネス不備の可能性）をAIに生成させる。

* 構成：表紙 / Top3リスク / 画像サムネ / 観点別（risk降順）/ Q\&A / 免責
* max\_evidence\_per\_issueで根拠の量を制御
* 3視点チェック：根拠の適切量/視線誘導/生成安定性

### **フェーズ6：統合・パフォーマンス・運用**

* トークン/時間/コスト計測、監査ログ（入力/Q\&A/出力/画像SHA/ルール版）
* リトライ制御、設定画面（保存期間・匿名化・撮影ガイドDL）
* **エラーハンドリング**: API通信失敗やタイムアウト時、「\[エラーコード] 処理に失敗しました。30秒後に自動で再試行します...」のような具体的なメッセージをUIに表示する。
* 3視点チェック：最少API呼び回数/進捗・復旧導線/保守性

## **2. ルールパック仕様（YAML/JSON）**

* requirement\_type: mandatory | guideline | best\_practice
* detection\_cues と ask\_when\_unknown で質問候補を保持
* severity\_weight と last\_reviewed を必須フィールド
* **likelihood\_cuesを追加**: 発生可能性を判断するためのキーワードや状況を追加する。

（例）

\- rule\_id: FOOD-CROSS-002  
domain: 食品衛生(交差汚染)  
law: 食品衛生法/HACCP  
clause: "一般衛生管理"  
requirement\_type: mandatory  
requirement: "器具の区分・洗浄消毒を実施すること"  
detection\_cues: \["生肉と非加熱野菜が近接", "器具色分け不明", "まな板が1枚のみ"]  
likelihood\_cues:  
high: \["生肉と野菜が直接接触", "血液が付着した器具で野菜を処理"]  
medium: \["同一の作業台で連続して処理", "手袋の交換なし"]  
low: \["近接しているが、物理的な仕切りあり"]  
ask\_when\_unknown: \["専用まな板/包丁の有無?", "洗浄手順・頻度?"]  
severity\_weight: 4  
last\_reviewed: "2025-08-01"

## **3. JSON出力スキーマ（内部保存/将来API用）**

（v1と同様。risk\_score, severity, likelihood, suggestions など必須）

## **4. プロンプト設計（温度分離）**

* **System**：

  * あなたは労働安全、建築、食品衛生、情報セキュリティの法規制とベストプラクティスに精通した監査エージェントです。
  * 観察根拠と規格根拠を必ず分離して記述してください。
  * 不明点がある場合は、ask\_when\_unknownに基づいて追加質問を生成してください。
  * **シーン分類タグ**（例：建設現場）を受け取り、その文脈で最も関連性の高いリスクを優先的に評価してください。
  * likelihood\_cuesを参考に、画像とテキストからリスクの発生可能性（likelihood）をhigh/medium/lowの3段階で評価してください。
  * 全ての回答の末尾に、法改正の可能性とユーザーによる最終確認責任に関する免責事項を自動で付与してください。

* **Assistant@0**：義務の欠落検出、断定的・簡潔
* **Assistant@0.7**：提案・代替策・教育ポイント、max\_suggestions順守

## **5. UI仕様（Streamlit）**

* テキスト図のとおり。タブ分割、枠線強弱、進捗ステッパー（線＋円）
* **独自ファビコン**を設定（例：盾+チェック+ルーペのシンボル）

## **6. 実装指針（Python 3.11／シンプル構成）**

最小で読みやすい**モジュール化**に留める。

app/  
main.py        # Streamlitエントリ \& 画面遷移（0.5図のUI）  
models.py      # OpenAI呼び出し（@0 質問/義務判定, @0.7 提案）  
rules.yml      # ルールパック（単一ファイル開始→将来分割）  
classify.py    # 画像→シーン推定（簡易タグ抽出）。画像から\['建設現場', '高所作業', '配線作業']のようなタグリストを生成し、後続のassess.pyへ渡す。  
assess.py      # 判定/提案の合成・risk\_score算出。classify.pyからのタグを基に、rules.ymlから関連ルールをフィルタリング・優先順位付けして評価を実行する。  
pdf.py         # PDF生成（html→pdf系）。最もrisk\_scoreの高い指摘からタイトルを自動生成する機能を含む。  
utils.py       # 画像I/O, ハッシュ, PIIぼかし, 例外処理。API通信失敗時のリトライロジックや、UIへのエラーメッセージ表示（例: st.error()）を担う関数群を含む。  
tests.py       # 主要ユニットテスト（最小）

* 将来は rules/ ディレクトリや tests/ を分割するが、MVPは上記で開始。

## **7. 重要度算出と並び替え**

* severity: {重大=3, 中=2, 軽微=1} （ルールパックで定義されたseverity\_weightを基に設定）
* likelihood: {高=3, 中=2, 低=1}
* risk\_score = severity\*likelihood\*10（0–90）
* **PDFは risk\_score 降順**。Top3を1ページ目に再掲。

#### **likelihood（発生可能性）の判断基準**

AIは以下の基準でlikelihoodを判断する。これはプロンプトにも反映される。

* **高 (High - 3)**:

  * 画像内で、まさに違反行為や危険な事象が**発生している瞬間**が確認できる。
  * ユーザーの説明文で、違反行為を**明確に記述**している。
  * 例：「保護具なしで高所作業中」「生肉を切った包丁を洗わずに野菜を切っている」

* **中 (Medium - 2)**:

  * 違反行為そのものではないが、放置すれば**高い確率でインシデントに繋がる状態**が確認できる。
  * 必要な安全設備や手順の一部が欠けている。
  * 例：「消火器の前に障害物が置かれている」「床に液体がこぼれたままになっている」「PCの画面ロックがされずに離席している」

* **低 (Low - 1)**:

  * 直ちに危険ではないが、規則上・手順上、**軽微な不備**がある状態。
  * リスクは存在するが、他の安全策によってある程度抑制されている。
  * 例：「ヘルメットの顎紐が少し緩んでいる」「書類が整理されずに積まれている」

## **8. テスト計画**

* ユニット：質問生成(@0)、ルール振り分け、risk計算、**likelihood判定ロジック**
* 統合：サンプル画像（建設/食品/オフィス）でE2E
* 負荷：画像20枚でタイムアウト/コスト閾値内

## **9. 運用・監査**

* 監査ログ：入力・Q\&A・出力・画像SHA256・ルール版・モデル名。**APIエラーや処理中断のログも記録**し、監査漏れのリスクを追跡可能にする。
* 保存期間：既定30日（設定で変更可）
* 免責：法改正はあり得る。最新版確認はユーザー責任である旨を明記

## **10. 設計論点（計画への回答）**

* **温度は2つで十分**（MVP）。必要なら0.3を将来オプション。
* **意見量は指定**（max\_questions/suggestions/evidence）。
* **レポートは重要度順**が最適。意思決定を早める。
* **likelihoodの判断基準**を導入し、risk\_scoreの客観性を向上させる。
* **PDFタイトルはAIで自動生成**し、ユーザーの手間を削減する。

## **11. 漏れ防止チェックリスト（着工前に再確認）**

* \[x] モデル切替（4.1-mini/4.1）と温度分離の実装方針が明記
* \[x] 観察根拠/規格根拠の分離ルールが明記
* \[x] 画像I/Oの安全化（拡張子/サイズ/EXIF/PII）
* \[x] Q&Aの**最大件数**と優先順制御
* \[x] risk\_score 算式の定数化とテスト
* \[x] **likelihoodの判断基準（高/中/低）とプロンプトへの反映**
* \[x] **シーン推定結果（タグ）の評価プロセスへの活用方法**
* \[x] PDFの**risk降順**・Top3再掲・**ファイル名（自動タイトル）規約**
* \[ ] 監査ログ項目（case\_id/時刻/モデル/ルール版/画像SHA）が固定
* \[x] 独自ファビコン設定（streamlit既定は不使用）
* \[x] **失敗時の具体的なUIメッセージと再実行の導線**
* \[x] 免責文＆規格の最終確認日 自動挿入
* \[x] **PowerShellスクリプト実装**（Windows環境での堅牢な実行環境構築）
* \[x] **ルールベースと推論ベースの組み合わせ**（人的要因と設備要因の両面検知）
* \[x] **消防法対応**（非常口・消火器・火災報知器の妨害検知）
* \[x] **バッチファイル問題の根本解決**（「... の使い方が誤っています」エラーの修正）
* \[x] **アプリケーション起動成功**（setup_and_run.bat/start_app.batで正常動作）
* \[x] **文字化け問題解決**（PowerShellスクリプトのASCIIメッセージ化）
* \[x] **仮想環境ロック問題解決**（プロセス停止→再作成機能）
* \[x] **インポート問題解決**（app/main.pyのフォールバック機能）
* \[x] **Streamlitセッション状態エラー解決**（ウィジェット初期化順序修正）